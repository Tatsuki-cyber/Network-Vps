name: Tailscale VPS (Router Access Enabled)
on:
  workflow_dispatch:

jobs:
  exit-node:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable IP Forwarding
        run: |
          sudo sysctl -w net.ipv4.ip_forward=1
          sudo sysctl -w net.ipv6.conf.all.forwarding=1
          sudo sysctl -p

      - name: Connect Tailscale
        uses: tailscale/github-action@v3
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          # This flag tells the tunnel to allow local LAN traffic (192.168.0.x)
          args: --advertise-exit-node --ssh --exit-node-allow-lan-access

      - name: Speed & Router Check
        run: |
          # Optimize for Mbps bypass
          sudo ethtool -K eth0 rx-udp-gro-forwarding on rx-gro-list off
          echo "VPS IP: $(tailscale ip -4)"
          echo "Bypass active. You can now access 192.168.0.1 locally."
          
      - name: Keep Alive
        run: sleep 21600
